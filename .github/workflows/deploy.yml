# .github/workflows/deploy.yml  (in hsarchitect-admin repo)
name: Build & Publish Admin

on:
    workflow_dispatch:
        inputs:
            deploy:
                description: "Push compiled admin to compiled-admin branch"
                required: false
                default: "true"
    push:
        branches: ["prod"] # optional: auto-publish on push to prod

concurrency:
    group: admin-build-deploy-${{ github.ref_name }}
    cancel-in-progress: true

permissions:
    contents: write

jobs:
    build-publish:
        runs-on: ubuntu-latest
        timeout-minutes: 20

        steps:
            - uses: actions/checkout@v4
              with: {fetch-depth: 1}

            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            # Safer on Linux for optional native deps
            - name: Clean install (Linux)
              run: |
                  rm -rf node_modules package-lock.json
                  npm install --no-audit --no-fund

            - name: Build admin
              run: npm run build

            - name: Sanity check (expect Quasar output in dist/spa)
              run: |
                  test -d dist/spa && echo "dist/spa exists." || (echo "Missing dist/spa/ (adjust if your output dir differs)" && exit 1)
                  [ "$(ls -A dist/spa | wc -l)" -gt 0 ] || (echo "dist/spa is empty" && exit 1)

            - name: Publish dist/spa to compiled-admin
              if: >
                  (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true') || github.event_name == 'push'


              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  BRANCH="compiled-admin"
                  PUBLISH_DIR="dist/spa"
                  GIT_NAME="github-actions[bot]"
                  GIT_EMAIL="github-actions[bot]@users.noreply.github.com"

                  rm -rf .publish && mkdir -p .publish
                  cp -a "$PUBLISH_DIR/." .publish/

                  cd .publish
                  git init
                  git config init.defaultBranch "$BRANCH"
                  git config user.name  "$GIT_NAME"
                  git config user.email "$GIT_EMAIL"
                  git checkout -b "$BRANCH"
                  echo > .nojekyll
                  echo "Compiled admin branch. Do not edit." > README.md
                  git add -A
                  if git diff --cached --quiet; then
                    echo "No changes to publish."
                    exit 0
                  fi
                  git commit -m "Publish compiled admin from ${GITHUB_SHA} ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
                  git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
                  git push -f origin "$BRANCH"
